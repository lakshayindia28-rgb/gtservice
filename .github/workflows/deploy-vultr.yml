name: Deploy (Vultr)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Git branch to deploy'
        required: true
        default: 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    # This job is automatically skipped until you add the required secrets.
    if: ${{ secrets.VULTR_HOST != '' && secrets.VULTR_USER != '' && secrets.VULTR_SSH_KEY != '' }}

    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VULTR_HOST }}
          username: ${{ secrets.VULTR_USER }}
          key: ${{ secrets.VULTR_SSH_KEY }}
          port: ${{ secrets.VULTR_PORT || 22 }}
          script: |
            set -e
            export DEPLOY_BRANCH='${{ inputs.branch }}'

            cd /var/www/thegtservices/app

            if [ -f scripts/deploy-on-server.sh ]; then
              bash scripts/deploy-on-server.sh
            elif [ -f clarity-sphere-lab/scripts/deploy-on-server.sh ]; then
              bash clarity-sphere-lab/scripts/deploy-on-server.sh
            else
              echo "ERROR: deploy script not found"
              exit 1
            fi

            sudo nginx -t
            sudo systemctl reload nginx

            # Optional: restart Contact API if you installed it as a service
            if systemctl list-unit-files | grep -q "gt-contact-api.service"; then
              sudo systemctl restart gt-contact-api
            fi
